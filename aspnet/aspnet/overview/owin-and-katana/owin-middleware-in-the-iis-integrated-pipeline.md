---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: "OWIN 미들웨어입니다. iis에서 통합 파이프라인 | Microsoft Docs"
author: Praburaj
description: "이 문서에서는 IIS 통합된 파이프라인의 OWIN 미들웨어 구성 요소 (OMCs)를 실행 하는 방법을 설명 하 고는 OMC 파이프라인 이벤트를 설정 하는 방법에서 실행 합니다. 다음 작업을 수행 해야합니다."
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2013
ms.topic: article
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 5f6ed1ae0309e9bdd3ca4ae229195835f20bc729
ms.sourcegitcommit: a510f38930abc84c4b302029d019a34dfe76823b
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 01/30/2018
---
<a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="efe23-104">IIS 통합된 파이프라인의 OWIN 미들웨어.</span><span class="sxs-lookup"><span data-stu-id="efe23-104">OWIN Middleware in the IIS integrated pipeline</span></span>
====================
<span data-ttu-id="efe23-105">여 [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="efe23-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="efe23-106">이 문서에서는 IIS 통합된 파이프라인의 OWIN 미들웨어 구성 요소 (OMCs)를 실행 하는 방법을 설명 하 고는 OMC 파이프라인 이벤트를 설정 하는 방법에서 실행 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="efe23-107">검토 해야 [An 프로젝트 Katana 개요](an-overview-of-project-katana.md) 및 [OWIN 시작 클래스 검색](owin-startup-class-detection.md) 이 자습서를 읽기 전에 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="efe23-108">이 자습서는 Rick Anderson에 의해 작성 되었으므로 ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan 및 Howard Dierking ( [ @howard \_dierking](https://twitter.com/howard_dierking) ).</span><span class="sxs-lookup"><span data-stu-id="efe23-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>


<span data-ttu-id="efe23-109">하지만 [OWIN](an-overview-of-project-katana.md) 미들웨어 구성 요소 (OMCs)는 주로 서버를 알 수 없는 파이프라인에서 실행 하도록 설계 되었습니다, 뿐 아니라 IIS 통합된 파이프라인에는 OMC를 실행할 수는 (**클래식 모드는 *하지* 지원**).</span><span class="sxs-lookup"><span data-stu-id="efe23-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="efe23-110">패키지 관리자 콘솔 (PMC)에서 다음 패키지를 설치 하 여 IIS 통합된 파이프라인에서 작업 하는 OMC 내릴 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="efe23-111">즉, 아직 수 없는 IIS와 System.Web, 외부에서 실행 하는 모든 응용 프로그램 프레임 워크 기존 OWIN 미들웨어 구성 요소에서 얻을 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="efe23-112">모든는 `Microsoft.Owin.Security.*` Visual Studio 2013의 새 Id 시스템으로 배송 패키지 (예: 쿠키, Microsoft 계정, Google, Facebook, Twitter, [전달자 토큰](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, 권한 부여 서버, JWT Azure Active 디렉터리 및 Active directory federation services), OMCs로 작성 되어 및 자체 호스팅 시나리오와 IIS에서 호스트 시나리오 모두에서 사용할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="efe23-113">OWIN 미들웨어입니다. IIS 통합된 파이프라인에서 실행 하는 방법</span><span class="sxs-lookup"><span data-stu-id="efe23-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="efe23-114">OWIN 콘솔 응용 프로그램에 대 한 응용 프로그램 파이프라인 사용 하 여 작성 된 [시작 구성](owin-startup-class-detection.md) 구성 요소를 사용 하 여 추가 되는 순서에 의해 설정 됩니다는 `IAppBuilder.Use` 메서드.</span><span class="sxs-lookup"><span data-stu-id="efe23-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="efe23-115">즉, OWIN 파이프라인에는 [Katana](an-overview-of-project-katana.md) 런타임 OMCs를 사용 하 여 등록 된 이러한 순서로 처리 됩니다 `IAppBuilder.Use`합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="efe23-116">IIS 통합된 파이프라인의 요청 파이프라인의 구성 [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) 와 같은 미리 정의 된 집합이 파이프라인 이벤트를 구독할 [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)등입니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="efe23-117">OMC 비교 하면는 [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) ASP.NET 세계 OMC는 미리 정의 된 올바른 파이프라인 이벤트에 등록 되어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="efe23-118">예를 들어 HttpModule `MyModule` 요청 도달할 경우 호출 됩니다는 [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) 파이프라인 단계에서에서:</span><span class="sxs-lookup"><span data-stu-id="efe23-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="efe23-119">이 동일한, 이벤트 기반 실행 순서에 참여 하도록 OMC 되려면에서는 [Katana](an-overview-of-project-katana.md) 런타임 코드를 통해 검색는 [시작 구성](owin-startup-class-detection.md) 구독 각 미들웨어 구성 요소에는 통합된 파이프라인 이벤트입니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="efe23-120">예를 들어 다음 OMC 및 등록 코드를 사용 하면 기본 이벤트 등록 미들웨어 구성 요소를 볼 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="efe23-121">(자세한 OWIN 시작 클래스를 만드는 방법에 대 한 지침은, 참조 [OWIN 시작 클래스 검색](owin-startup-class-detection.md).)</span><span class="sxs-lookup"><span data-stu-id="efe23-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="efe23-122">빈 웹 응용 프로그램 프로젝트를 만들고 이름을 **owin2**합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="efe23-123">패키지 관리자 콘솔 (PMC)에서 다음 명령을 실행 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="efe23-124">추가 `OWIN Startup Class` 하 고 이름을 `Startup`합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="efe23-125">생성된 된 코드 (변경 내용을 강조 표시)를 다음과 같이 바꿉니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="efe23-126">F5 키를 눌러 앱을 실행 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="efe23-127">시작 구성 세 미들웨어 구성 요소, 처음 두 개의 진단 정보 및 이벤트에 응답 하는 마지막 트랜잭션이 표시 (및 진단 정보를 표시 하는 또한) 포함 된 파이프라인을 설정 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="efe23-128">`PrintCurrentIntegratedPipelineStage` 메서드가이 미들웨어에서 호출 되는 통합된 파이프라인 이벤트 및 메시지를 표시 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="efe23-129">다음 출력 창을 표시 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="efe23-130">Katana 런타임 OWIN 미들웨어 구성 요소와의 각 매핑된 [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) IIS 파이프라인 이벤트에 해당 하는 기본적으로 [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx)합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="efe23-131">표식 단계</span><span class="sxs-lookup"><span data-stu-id="efe23-131">Stage Markers</span></span>

<span data-ttu-id="efe23-132">사용 하 여 파이프라인의 특정 단계에서 실행 하는 OMCs를 표시할 수 있습니다는 `IAppBuilder UseStageMarker()` 확장 메서드.</span><span class="sxs-lookup"><span data-stu-id="efe23-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="efe23-133">특정 단계에서 미들웨어 구성 요소 집합을 실행 한 단계 마커 마지막 구성 요소 바로 뒤에 삽입을 등록 하는 동안 집합입니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="efe23-134">규칙이 파이프라인의 단계에서 미들웨어를 실행할 수 있습니다 및 구성 요소 배열에서 실행 해야 합니다 (규칙은이 자습서의 뒷부분에 나오는 설명 됨).</span><span class="sxs-lookup"><span data-stu-id="efe23-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="efe23-135">추가 `UseStageMarker` 메서드는 `Configuration` 아래와 같이 코드:</span><span class="sxs-lookup"><span data-stu-id="efe23-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="efe23-136">`app.UseStageMarker(PipelineStage.Authenticate)` 호출 (이 경우 두 개의 진단 구성)의 모든 이전에 등록 된 미들웨어 구성 요소를 파이프라인의 인증 단계에서 실행 되도록 구성 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="efe23-137">마지막 미들웨어 구성 요소 (표시 하는 진단 요청에 응답 하)에서 실행 되는 `ResolveCache` 단계 (의 [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) 이벤트).</span><span class="sxs-lookup"><span data-stu-id="efe23-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="efe23-138">F5 키를 눌러 앱을 실행 합니다. 출력 창에 표시</span><span class="sxs-lookup"><span data-stu-id="efe23-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="efe23-139">표식 규칙 단계</span><span class="sxs-lookup"><span data-stu-id="efe23-139">Stage Marker Rules</span></span>

<span data-ttu-id="efe23-140">Owin 미들웨어 구성 요소 (OMC) 다음 OWIN 파이프라인 단계 이벤트에서 실행 되도록 구성할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="efe23-141">기본적으로 OMCs 마지막 이벤트에서 실행 (`PreHandlerExecute`).</span><span class="sxs-lookup"><span data-stu-id="efe23-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="efe23-142">바로 이러한 이유로 첫 번째 예제 코드는 "PreExecuteRequestHandler"를 표시 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="efe23-143">사용할 수는 `app.UseStageMarker` OWIN 파이프라인의 각 단계 이전에 실행 되도록 OMC 등록에 나열 된는 `PipelineStage` 열거형입니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="efe23-144">OWIN 파이프라인으로, IIS 파이프라인 정렬 되는 경우 따라서에 대 한 호출 `app.UseStageMarker` 순서 여야 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="efe23-145">이벤트 처리기에 등록 된 마지막 이벤트 앞에 오는 이벤트를 설정할 수 없습니다 `app.UseStageMarker`합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="efe23-146">예를 들어 *후* 호출:</span><span class="sxs-lookup"><span data-stu-id="efe23-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

 <span data-ttu-id="efe23-147">에 대 한 호출이 `app.UseStageMarker` 전달 `Authenticate` 또는 `PostAuthenticate` 유효 하며, 수 없으며 예외가 throw 됩니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="efe23-148">기본적으로 최신 단계에서 실행 OMCs `PreHandlerExecute`합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="efe23-149">단계 마커를 먼저 실행 되도록 하는 데 사용 됩니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="efe23-150">순서가 단계 마커를 지정 하면 이전 표식에 반올림 했습니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="efe23-151">즉, 한 단계 마커 추가 "단계 X 늦어도 실행" 표시 됩니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="efe23-152">OWIN 파이프라인의 다음에 추가 하는 가장 빠른 단계 마커 OMC의 실행 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="efe23-153">최초의 단계에 대 한 호출 `app.UseStageMarker` wins 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="efe23-154">예를 들어, 순서를 전환 하는 경우 `app.UseStageMarker` 이전 예제에서 호출 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

 <span data-ttu-id="efe23-155">출력 창에 표시 됩니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

 <span data-ttu-id="efe23-156">모든 연속된 OMCs는 `AuthenticateRequest` 마지막 OMC로 등록 되었으므로 단계는 `Authenticate` 이벤트, 및 `Authenticate` 이벤트에는 다른 모든 이벤트 앞에 합니다.</span><span class="sxs-lookup"><span data-stu-id="efe23-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
